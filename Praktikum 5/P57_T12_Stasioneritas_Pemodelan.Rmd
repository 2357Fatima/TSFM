---
title: "Tugas Praktikum MPDW (5-7)"
author: "Fatima Azzahra - G1401231036"
date: "2025-09-30"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    css: "D:/style.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("lubridate")
library("readr")
library("readxl")
library("dplyr")
library("forecast")
library("graphics")
library("TTR")
library("TSA")
library("ggplot2")
```

```{r}
library(tseries)
library(tsibble)
library(MASS)
```

# Import Data

**Deskripsi**\
Dataset ini merupakan pencatatan berbagai macam komponen terkait cuaca dengan periode pencatatan per 10 menit dari tanggal 1 Januari 2020 sampai 31 Desember 2020. Analisis akan difokuskan pada peubah VPdef (Vapor Pressure Deficit).

Terkait cakupan analisis untuk tugas ini, akan dianalisis 100 baris pertama untuk peubah VPdef dengan cakupan periodenya yaitu 1 Januari 2020 pada menit ke-10 sampai 16:40.

```{r}
weather <- read_csv("D:\\TAHUN 3\\G1_MPDW\\cleaned_weather.csv")
View(weather)
str(weather)
```

```{r}
# Change date format from chr to datetime
weather <- weather %>%
  mutate(datetime = mdy_hm(date))
# new dataframe with datetime and VPdef as respond variable
weather1 <- weather %>%
  dplyr::select(datetime, VPdef)
View(weather1)
str(weather1)
```

```{r}
# Check if there's missing value from time frequency per day
weather1 %>%
  group_by(date_only = as.Date(datetime)) %>%
  summarise(n_obs = n(), .groups = "drop") %>%
  filter(n_obs != 144)
```

**Note: Missing Value and Duplicate**

Per hari harusnya memiliki **144 observasi** karena mencatat data parameter cuaca dalam 24 jam per 10 menit. Hasil filtering tersebut mengindikasikan adanya missing value dan duplicate yang perlu ditangani bila analisis melibatkan observasi tersebut. Khusus pada data 2020-01-01 memang dicatat dari menit ke-10, data pada tanggal **5 dan 12 Mei 2020** saja yang perlu ditangani.

```{r}
# Create the data subset
w1 <- weather1[1:100,]
head(w1, 20)
View(w1)
```

```{r}
# Change the data format to time series using 'ts' function
w1.ts <- ts(w1$VPdef)
summary(w1.ts)
w1.ts
```

**Note: Time Series Data Frequency**

Pada tahap eksplorasi awal ini digunakan frequency = 1 karena baru mengamati observasi dalam skala yang kecil.

# Eksplorasi Data

## Plot TS Penuh

```{r}
ts.plot(w1.ts, xlab="Time Period", ylab="VPdef", 
        main = "1 Jan (0:10 - 16:40)")
points(w1.ts)
```

Berdasarkan plot, data deret waktunya mengindikasikan **tidak stasioner pada rataam dan ragam**.\

**Pembagian Data Latih dan Data Uji**

```{r}
#split training data and testing data
training <- w1[1:80,]
testing <- w1[81:100,]
train.ts <- ts(training$VPdef)
test.ts <- ts(testing$VPdef)
```

## Plot TS Latih

```{r}
# explore training data
plot(train.ts, col="blue",main="Plot data latih")
points(train.ts)
```

## Plot TS Uji

```{r}
# explore testing data
plot(test.ts, col="blue",main="Plot data uji")
points(test.ts)
```

# Uji Stasioneritas 

## Plot ACF

```{r}
acf(train.ts)
```

Plot ACF menunjukkan penurunan yang lambat pada lag nya. Hal ini mengindikasikan data tak stasioner dalam rataan.

## Uji ADF

```{r}
tseries::adf.test(train.ts)
```
$H_0$ : Data tidak stasioner dalam rataan\

$H_1$ : Data stasioner dalam rataan\

Berdasarkan uji ADF tersebut, didapat *p-value* lebih besar dari taraf nyata 5% sehingga Tak Tolak $H_0$ dan menandakan bahwa **data tidak stasioner dalam rataan**. Hal ini sesuai dengan hasil eksplorasi menggunakan plot time series penuh dan plot ACF.

## Plot Box-Cox

```{r}
index <- seq_along(train.ts)

# Uji Box-Cox
bc <- boxcox(
  train.ts ~ index,
  lambda = seq(-2,2, by = 0.1)
)

# Nilai lambda optimum
lambda <- bc$x[which.max(bc$y)]
lambda

# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Selang lambda tidak mengandung satu [-0.6666667, 0.1414141] sehingga **data tidak stasioner juga dalam ragam.**

# Penanganan Ketidakstasioneran

Dalam analisis deret waktu, differencing merupakan salah satu prosedur
transformasi yang digunakan untuk memperoleh sifat stasioneritas dalam
rataan. Metode ini dilakukan dengan menghitung selisih nilai observasi
antar periode sehingga pola tren atau ketidakstasioneran dalam rataan
dapat dieliminasi.

Secara umum, pembedaan pertama ditulis sebagai:

$$
\nabla Y_t = Y_t - Y_{t-1}
$$

Jika tren linier masih tersisa/ belum stasioner, dapat dilakukan
differencing kedua:\
$$
\nabla^2 Y_t = \nabla (\nabla Y_t) = Y_t - 2Y_{t-1} + Y_{t-2}
$$

## Diferensiasi Pertama
```{r}
train.diff1<-diff(train.ts,differences = 1) 
plot.ts(train.diff1, lty=1, xlab="waktu", ylab="Data Difference 1 VPdef", main="Plot Difference 1 VPdef")
```

**Plot ACF**

```{r}
acf(train.diff1)
```

Plot ACF masih menunjukkan indikasi data belum stasioner dalam rataan.\

**Uji ADF**

```{r}
tseries::adf.test(train.diff1)
```
$H_0$ : Data tidak stasioner dalam rataan\

$H_1$ : Data stasioner dalam rataan\

Berdasarkan uji ADF tersebut, didapat *p-value* lebih besar dari taraf nyata 5% sehingga Tak Tolak $H_0$ dan menandakan bahwa **data tidak stasioner dalam rataan**. Sehingga perlu dilakukan diferensiasi kedua.

## Diferensiasi Kedua

```{r}
train.diff2<-diff(train.ts,differences = 2) 
plot.ts(train.diff2, lty=1, xlab="waktu", ylab="Data Difference 2 VPdef", main="Plot Difference 2 VPdef")
```

**Plot ACF**

```{r}
acf(train.diff2)
```

**Plot ADF**

```{r}
tseries::adf.test(train.diff2)
```
$H_0$ : Data tidak stasioner dalam rataan\

$H_1$ : Data stasioner dalam rataan\

Berdasarkan uji ADF tersebut, didapat *p-value* sebesar 0.01 yang lebih kecil dari taraf nyata 5% sehingga Tolak $H_0$ dan menandakan bahwa **data sudah stasioner dalam rataan**.\

**Plot Box-Cox**

```{r}
min(train.diff2)
```

```{r}
index <- seq_along(train.diff2)

# Uji Box-Cox
bc <- boxcox(
  (train.diff2 - min(train.diff2) + 0.16) ~ index,
  lambda = seq(-2, 2, by = 0.1)
)

# Nilai lambda optimum
lambda <- bc$x[which.max(bc$y)]
lambda

# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Selang lambda mengandung satu [0.02020202, 1.71717172] sehingga **data stasioner dalam ragam** juga setelah diferensiasi 2 kali.

## Simpulan
Data cuaca 100 baris pertama (peubah VPdef) memiliki plot deret waktu yang mengindikasikan pola yang tidak stasioner baik dalam rataan maupun ragam. Hal ini terbukti dengan plot ACF yang mengalami penurunan secara lambat pada lagnya, Uji ADF dengan p-value lebih besar dari 5% serta selang kepercayaan lambda pada plot Box-cox tidak mengandung nilai 1.\

Setelah dilakukan diferensiasi 1 kali, stasioneritas rataan belum teratasi dan dilanjut percobaan dengan diferensiasi 2 kali. Hasilnya data stasioner dalam rataan berdasarkan nilai p-value uji ADF sebesar 0.01 yang lebih kecil dari 5% dan plot Box-cox yang mengandung nilai satu dalam selang kepercayaannya.\

# Identifikasi Model

## Plot ACF

```{r}
acf(train.diff2)
```

Berdasarkan plot tersebut, terlihat bahwa plot ACF cenderung *cuts off* pada lag ke 1, sehingga jika plot PACF dianggap *tails of*, maka model tentatifnya adalah ARIMA(0,2,1).

## Plot PACF

```{r}
pacf(train.diff2)
```

Berdasarkan plot tersebut, terlihat bahwa plot PACF cenderung *tails off* pada lag ke 1, sehingga model yang terbentuk adalah ARIMA(0,2,1)

## Plot EACF

```{r}
eacf(train.diff2)
```

Identifikasi model menggunakan plot EACF dilakukan dengan melihat ujung segitiga pada pola segitiga nol. Dalam hal ini model tentatif yang terbentuk adalah ARIMA(1,2,1), ARIMA(2,2,1), ARIMA(2,2,3)ndan ARIMA(3,2,4).

# Pendugaan Parameter Model Tentatif

## 1. ARIMA(0,2,1)

```{r}
model1=Arima(train.diff2, order=c(0,0,1),method="ML")
summary(model1) #AIC=-233.06
lmtest::coeftest(model1) #seluruh parameter signifikan
```

## 2. ARIMA(1,2,1)

```{r}
model2=Arima(train.diff2, order=c(1,0,1),method="ML")
summary(model2) #AIC=-232.14
lmtest::coeftest(model2) #terdapat parameter tak signifikan
```

## 3. ARIMA(2,2,1)

```{r}
model3=Arima(train.diff2, order=c(2,0,1),method="ML")
summary(model3) #AIC=-230.52
lmtest::coeftest(model3) #terdapat parameter tak signifikan
```

## 4. ARIMA(2,2,3)

```{r}
model4=Arima(train.diff2, order=c(2,0,3),method="ML")
summary(model4) #AIC=-230
lmtest::coeftest(model4) #terdapat parameter tidak signifikan
```

## 5. ARIMA(3,2,4)

```{r}
model5=Arima(train.diff2, order=c(3,0,4),method="ML")
summary(model5) #AIC=-226
lmtest::coeftest(model5) #erdapat parameter tidak signifikan
```

Berdasarkan pendugaan parameter di atas, nilai AIC terkecil dimiliki oleh model ARIMA(0,2,1) dan parameter modelnya juga seluruhnya signifikan, sehingga model yang dipilih adalah model ARIMA(0,2,1).

# Analisis Sisaan

Model terbaik hasil identifikasi kemudian dicek asumsi sisaannya. Sisaan model ARIMA harus memenuhi asumsi normalitas, kebebasan sisaan, dan kehomogenan ragam. Diagnostik model dilakukan secara eksplorasi dan uji formal.

## Eksplorasi Sisaan

**ARIMA (0,2,1)**

```{r}
#Eksplorasi 
sisaan1 <- model1$residuals 
par(mfrow=c(2,2)) 
qqnorm(sisaan1) 
qqline(sisaan1, col = "blue", lwd = 2) 
plot(c(1:length(sisaan1)),sisaan1) 
acf(sisaan1) 
pacf(sisaan1) 
par(mfrow = c(1,1))
```

Berdasarkan plot kuantil-kuantil normal, secara eksplorasi ditunjukkan sisaan tidak menyebar normal ditandai dengan titik titik yang cenderung tidak mengikuti garis $45^{\circ}$. Sedangkan berdasarkan lebar pita plot sisaan, homoskedastisitas dan nilai harapan nol terpenuhi. Lalu pada plot ACF dan PACF mengindikasikan tidak terdapat autokorelasi.

## Uji Formal

```{r}
#1) Sisaan Menyebar Normal 
ks.test(sisaan1,"pnorm")# tolak H0 > sisaan tidak menyebar normal
```

Hipotesis pada uji KS\

$H_0$ : Sisaan menyebar normal\

$H_1$ : Sisaan tidak menyebar normal\

Berdasarkan uji KS tersebut, didapat *p-value* sebesar 3.442e-15 yang kurang dari taraf nyata 5% sehingga tolak $H_0$ dan menandakan bahwa **sisaan tidak menyebar normal**. Hal ini sesuai dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.

```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi 
Box.test(sisaan1, type = "Ljung")#tak tolak H0 > sisaan saling bebas
```

Selanjutnya akan dilakukan uji formal untuk kebebasan sisaan menggunakan uji Ljung-Box. Hipotesis yang digunakan adalah sebagai berikut.\

$H_0$ : Sisaan saling bebas\

$H_1$ : Sisaan tidak tidak saling bebas\

Berdasarkan uji Ljung-Box tersebut, didapat *p-value* sebesar 0.267 yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa **sisaan saling bebas**. Hal ini sesuai dengan eksplorasi.

```{r}
#3) Sisaan homogen 
Box.test((sisaan1)^2, type = "Ljung")#tolak H0 > ragam sisaan homogen
```

Hipotesis yang digunakan untuk uji kehomogenan ragam adalah sebagai berikut.\

$H_0$ : Ragam sisaan homogen\

$H_1$ : Ragam sisaan tidak homogen\

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat *p-value* sebesar 0.8112 yang lebih besar dari taraf nyata 5% sehingga tolak $H_0$ dan menandakan bahwa **ragam sisaan homogen**.\

```{r}
#4) Nilai tengah sisaan sama dengan nol 
t.test(sisaan1, mu = 0, conf.level = 0.95)#tak tolak h0 > nilai tengah sisaan sama dengan 0
```

Terakhir, dengan uji-t, akan dicek apakah nilai tengah sisaan sama dengan nol. Hipotesis yang diujikan sebagai berikut.\

$H_0$ : nilai tengah sisaan sama dengan 0\

$H_1$ : nilai tengah sisaan tidak sama dengan 0\

Berdasarkan uji-ttersebut, didapat *p-value* sebesar 0.6463 yang lebih besar dari taraf nyata 5% sehingga tolak $H_0$ dan menandakan bahwa **nilai tengah sisaan sama dengan nol**. Hal ini sesuai dengan eksplorasi.\

## Simpulan

Model ARIMA (0,2,1) tidak memenuhi asumsi kenormalan sisaan.

# Overfitting

Pada model tentatif, terdapat model overfitting yang sudah dicek, yaitu ARIMA (2,2,1). Hasilnya tidak lebih baik dari model yang dipilih karena nilai AIC nya lebih besar dan terdapat parameter yang tak signifikan di dalam modelnya. Selanjutnya sebagai eksplorasi tambahan akan dicek model overfitting lainyya yaitu **ARIMA (0,2,2)**.

```{r}
model.ovt=Arima(train.diff2, order=c(0,0,2),method="ML")
summary(model.ovt) #AIC=-232.28
lmtest::coeftest(model.ovt) #terdapat parameter tak signifikan
```

Hasil ARIMA (0,2,2) juga tidak lebih baik, sehingga model terbaik tetap ARIMA (0,2,1)'

# Peramalan

Peramalan dilakukan menggunakan fungsi `forecast()` . Contoh peramalan berikut ini dilakukan untuk 2 jam kedepan.

```{r}
#---FORECAST---#
ramal <- forecast::forecast(model1, h = 12) 
ramal
data.ramal<- ramal$mean
plot(ramal)
```

Berdasarkan hasil plot ramalan di atas, dapat dilihat bahwa ramalan ARIMA(0,2,1) cenderung stabil hingga akhir periode. Selanjutnya, dapat dicari nilai akurasi antara hasil ramalan dengan data uji sebagai berikut.

```{r}
pt_1 <- train.ts[80] #nilai akhir data latih
hasil.forc.Diff <- data.ramal
hasil <- diffinv(hasil.forc.Diff, differences = 2) + pt_1
#has.1 sama hasilnta dengan: cumsum(c(pt_1,hasil.forc.Diff))
ts.plot(train.ts,hasil)
```

```{r}
perbandingan<-matrix(data=c(head(test.ts, n=12), hasil[-1]),
                     nrow = 12, ncol = 2)
colnames(perbandingan)<-c("Aktual","Hasil Forecast")
perbandingan
accuracy(ts(hasil[-1]), head(test.ts, n=12))
```

Model ARIMA (0,2,1) memiliki nilai MAPE kurang dari 10% sebesar 7,79%, performa model baik untuk peramalan.